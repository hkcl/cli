#!/usr/bin/env node

const sh = require('shelljs')
const fs = require('fs-extra')

sh.set('-ev')

const {version} = fs.readJSONSync('package.json')
const example = process.env.CIRCLE_JOB
const [, type,, format] = example.split('-')

const options = format === 'typescript' ?
  '--options=typescript,mocha,semantic-release' :
  '--options=mocha,semantic-release'

sh.cd(`examples/${example}`)
sh.exec('git fetch')
sh.exec('git checkout master')
sh.exec('git pull --rebase origin master')

sh.rm('-rf', [
'.circleci',
'.editorconfig',
'.eslintignore',
'.eslintrc',
'.gitattributes',
'.gitignore',
'appveyor.yml',
'bin',
'package-scripts.js',
'README.md',
'src',
'test',
'tsconfig.json',
'tslint.json',
'yarn.lock'
].join(' '))

const pjson = fs.readJSONSync('package.json')
fs.outputJSONSync('package.json', {
  name: `@dxcli/${example}`,
  repository: `dxcli/${example}`,
  author: pjson.author,
  version: pjson.version,
})

sh.exec(`yarn create dxcli ${type} --force --defaults ${options}`)
sh.exec('git add .')
sh.exec(`git commit -m "fix: create-dxcli ${version}"`)
sh.exec('git push')
sh.cd('../..')
sh.exec(`git add examples/${example}`)
sh.exec(`git commit -m "chore: ${example} updated [ci-skip]`)

let retries = 4
function push() {
  try {
    sh.exec('git pull --rebase origin master')
    sh.exec('git push')
  } catch (err) {
    retries--
    if (retries > 0) return push()
    throw err
  }
}
